pipeline:
  emailserviceimageclone:
    image: ubuntu:20.04
    secrets: [aws_access_key_id, aws_secret_access_key, bucket]
    commands:
      - apt-get update
      - apt-get install -y git python3 python3-pip python3-venv jq curl patch
      - git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
      - echo $BUCKET > /tmp/bucket
      - export bucket=$(cat /tmp/bucket)
      - cat images/emailservice/config.json | jq --arg bucket "$bucket" '.CloudConfig.BucketName = $bucket' > microservices-demo/src/emailservice/config.json
      - cp -rf images/emailservice/usr microservices-demo/src/emailservice/
      - cp images/emailservice/logger.patch microservices-demo/src/emailservice/
      - cd microservices-demo/src/emailservice
      - patch logger.py logger.patch
      - python3 -m venv .venv --prompt nanovm
      - source .venv/bin/activate
      - pip3 install --upgrade pip
      - pip3 install -r requirements.txt
      - deactivate
      - curl https://ops.city/get.sh -sSfL | sh
      - /root/.ops/bin/ops image create --package python_3.8.6 -i emailservice -c config.json --show-debug -t aws
branches: master
